{% extends "base.html" %}

{% block title %}Alert Details - Network Intrusion Detection System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-exclamation-triangle"></i> Alert Details
                <small class="text-muted">ID: #{{ alert.id }}</small>
            </h2>
            <div>
                <a href="{{ url_for('alerts') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Alerts
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-{{ 'success' if alert.severity == 'low' else 'warning' if alert.severity == 'medium' else 'danger' if alert.severity == 'high' else 'dark' }} text-white">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle"></i> {{ alert.alert_type.replace('_', ' ').title() }} Alert
                    <span class="badge bg-light text-dark ms-2">{{ alert.severity.upper() }}</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Alert ID:</strong> #{{ alert.id }}
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong> 
                        <span class="badge bg-{{ 'success' if alert.status == 'resolved' else 'danger' if alert.status == 'active' else 'warning' }}">
                            {{ alert.status.replace('_', ' ').title() }}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Created:</strong> {{ alert.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}
                    </div>
                    <div class="col-md-6">
                        <strong>Severity:</strong> 
                        <span class="badge bg-{{ 'success' if alert.severity == 'low' else 'warning' if alert.severity == 'medium' else 'danger' if alert.severity == 'high' else 'dark' }}">
                            {{ alert.severity.upper() }}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Source IP:</strong> 
                        <code>{{ alert.source_ip }}</code>
                    </div>
                    <div class="col-md-6">
                        <strong>Target IP:</strong> 
                        <code>{{ alert.target_ip }}</code>
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Description:</strong>
                    <p class="mt-1">{{ alert.description }}</p>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Digital Signature Verification:</strong>
                        <div class="mt-1">
                            {% if signature_valid %}
                            <span class="badge bg-success">
                                <i class="fas fa-check"></i> Signature Valid - Alert Integrity Confirmed
                            </span>
                            {% else %}
                            <span class="badge bg-danger">
                                <i class="fas fa-times"></i> Signature Invalid - Alert May Be Tampered
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Alert Hash (SHA-256):</strong>
                        <div class="mt-1">
                            <code class="small">{{ alert.alert_hash }}</code>
                        </div>
                    </div>
                </div>
                
                {% if alert.status == 'resolved' and alert.resolved_by %}
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> Resolution Information</h6>
                    <p class="mb-0">
                        <strong>Resolved by:</strong> {{ alert.resolver.username }} ({{ alert.resolver.role }})<br>
                        <strong>Resolved at:</strong> {{ alert.resolved_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-lock"></i> Decrypted Alert Data
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    This alert data was decrypted using AES-256 and verified with RSA digital signatures.
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <strong>Alert Type:</strong> {{ alert_data.type }}
                    </div>
                    <div class="col-md-6">
                        <strong>Timestamp:</strong> {{ alert_data.timestamp }}
                    </div>
                </div>
                
                <div class="mt-3">
                    <strong>Full Description:</strong>
                    <p class="mt-1">{{ alert_data.description }}</p>
                </div>
                
                <div class="mt-3">
                    <strong>Raw Alert JSON:</strong>
                    <pre class="mt-1"><code>{{ alert_data | tojson(indent=2) }}</code></pre>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-shield-alt"></i> Security Analysis
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Threat Assessment</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-{{ 'success' if alert.severity == 'low' else 'warning' if alert.severity == 'medium' else 'danger' if alert.severity == 'high' else 'dark' }}" 
                             style="width: {{ '25' if alert.severity == 'low' else '50' if alert.severity == 'medium' else '75' if alert.severity == 'high' else '100' }}%">
                            {{ alert.severity.title() }}
                        </div>
                    </div>
                    <small class="text-muted">
                        Risk level based on attack pattern and potential impact
                    </small>
                </div>
                
                <div class="mb-3">
                    <h6>Recommended Actions</h6>
                    {% if alert.alert_type == 'flooding' %}
                    <ul class="small">
                        <li>Monitor bandwidth utilization</li>
                        <li>Consider rate limiting</li>
                        <li>Block source IP if necessary</li>
                        <li>Review firewall rules</li>
                    </ul>
                    {% elif alert.alert_type == 'port_scan' %}
                    <ul class="small">
                        <li>Investigate source IP reputation</li>
                        <li>Review exposed services</li>
                        <li>Consider IP blocking</li>
                        <li>Enhance monitoring</li>
                    </ul>
                    {% elif alert.alert_type == 'anomaly' %}
                    <ul class="small">
                        <li>Analyze traffic patterns</li>
                        <li>Check for malware indicators</li>
                        <li>Review system logs</li>
                        <li>Update baselines if needed</li>
                    </ul>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <h6>Technical Details</h6>
                    <div class="small">
                        <div class="mb-2">
                            <strong>Detection Method:</strong> Statistical Analysis
                        </div>
                        <div class="mb-2">
                            <strong>Confidence Level:</strong> 
                            <span class="badge bg-warning">Medium</span>
                        </div>
                        <div class="mb-2">
                            <strong>False Positive Risk:</strong> 
                            <span class="badge bg-info">Low</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-cogs"></i> NIDS Processing
                </h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="mb-2">
                        <i class="fas fa-check text-success"></i> Packet captured at network boundary
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-check text-success"></i> Traffic analysis completed
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-check text-success"></i> Anomaly detected
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-check text-success"></i> Alert generated and signed
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-check text-success"></i> Data encrypted and stored
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-check text-success"></i> Digital signature verified
                    </div>
                </div>
            </div>
        </div>
        
        {% if current_user.role in ['admin', 'analyst'] and alert.status == 'active' %}
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="fas fa-tools"></i> Alert Actions
                </h6>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('resolve_alert', alert_id=alert.id) }}">
                    <div class="mb-3">
                        <label for="resolution_notes" class="form-label">Resolution Notes</label>
                        <textarea class="form-control" id="resolution_notes" name="resolution_notes" rows="3" 
                                  placeholder="Add notes about how this alert was resolved..."></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i> Mark as Resolved
                        </button>
                    </div>
                </form>
                
                <hr>
                
                <div class="d-grid">
                    <button class="btn btn-outline-warning" onclick="markFalsePositive({{ alert.id }})">
                        <i class="fas fa-times"></i> Mark as False Positive
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function markFalsePositive(alertId) {
        if (confirm('Are you sure you want to mark this alert as a false positive?')) {
            // In a real implementation, this would make an AJAX call
            alert('Functionality to mark as false positive would be implemented here');
        }
    }
    
    // Auto-refresh alert details every 30 seconds if status is active
    {% if alert.status == 'active' %}
    setInterval(function() {
        console.log('Refreshing alert details...');
        // In production, this would make an AJAX call to get updated alert status
    }, 30000);
    {% endif %}
</script>
{% endblock %}
