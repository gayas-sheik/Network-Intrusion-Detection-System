{% extends "base.html" %}

{% block title %}System Configuration - Network Intrusion Detection System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-cog"></i> System Configuration
                <small class="text-muted">NIDS Settings & Parameters</small>
            </h2>
            <div>
                {% if current_user.role == 'admin' %}
                <button class="btn btn-primary btn-sm" onclick="addConfig()">
                    <i class="fas fa-plus"></i> Add Setting
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Configuration Categories -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">{{ configs | selectattr('config_key', 'search', 'detection') | list | length }}</h5>
                <p class="card-text">Detection Rules</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">{{ configs | selectattr('config_key', 'search', 'threshold') | list | length }}</h5>
                <p class="card-text">Thresholds</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">{{ configs | selectattr('config_key', 'search', 'security') | list | length }}</h5>
                <p class="card-text">Security Settings</p>
            </div>
        </div>
    </div>
</div>

<!-- Configuration List -->
<div class="card">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">
            <i class="fas fa-cogs"></i> NIDS Configuration Parameters
            <span class="badge bg-light text-dark ms-2">{{ configs|length }}</span>
        </h5>
    </div>
    <div class="card-body">
        {% if configs %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Setting</th>
                            <th>Value</th>
                            <th>Description</th>
                            <th>Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for config in configs %}
                        <tr>
                            <td>
                                <code>{{ config.config_key }}</code>
                                {% if config.is_encrypted %}
                                <i class="fas fa-lock text-warning ms-1" title="Encrypted"></i>
                                {% endif %}
                            </td>
                            <td>
                                {% if config.is_encrypted %}
                                <span class="text-muted">••••••••••••••••</span>
                                {% else %}
                                <code>{{ config.config_value }}</code>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ config.description or 'No description available' }}</small>
                            </td>
                            <td>
                                <small>{{ config.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                {% if config.updater %}
                                <br><small class="text-muted">by {{ config.updater.username }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if current_user.role == 'admin' %}
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editConfig({{ config.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteConfig({{ config.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                {% else %}
                                <span class="text-muted">Read-only</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-cog fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No Configuration Settings</h5>
                <p class="text-muted">No system configuration settings have been defined yet.</p>
                {% if current_user.role == 'admin' %}
                <button class="btn btn-primary" onclick="addConfig()">
                    <i class="fas fa-plus"></i> Add First Setting
                </button>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Default Configuration Template -->
<div class="card mt-4 border-info">
    <div class="card-header bg-info text-white">
        <h6 class="mb-0">
            <i class="fas fa-info-circle"></i> Default NIDS Configuration
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-shield-alt"></i> Detection Rules</h6>
                <table class="table table-sm">
                    <tr>
                        <td><code>detection.flooding.packet_threshold</code></td>
                        <td>1000 packets/sec</td>
                    </tr>
                    <tr>
                        <td><code>detection.flooding.bandwidth_threshold</code></td>
                        <td>1MB/sec</td>
                    </tr>
                    <tr>
                        <td><code>detection.port_scan.port_threshold</code></td>
                        <td>50 ports/60sec</td>
                    </tr>
                    <tr>
                        <td><code>detection.anomaly.deviation_threshold</code></td>
                        <td>3.0 std dev</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-lock"></i> Security Settings</h6>
                <table class="table table-sm">
                    <tr>
                        <td><code>security.encryption.algorithm</code></td>
                        <td>AES-256-GCM</td>
                    </tr>
                    <tr>
                        <td><code>security.signature.algorithm</code></td>
                        <td>RSA-2048-PSS</td>
                    </tr>
                    <tr>
                        <td><code>security.hash.algorithm</code></td>
                        <td>SHA-256</code></td>
                    </tr>
                    <tr>
                        <td><code>security.session.timeout</code></td>
                        <td>30 minutes</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-cog"></i> <span id="configModalTitle">Configuration Setting</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="configForm">
                    <input type="hidden" id="configId" name="configId">
                    
                    <div class="mb-3">
                        <label for="configKey" class="form-label">Configuration Key</label>
                        <input type="text" class="form-control" id="configKey" name="configKey" required>
                        <div class="form-text">Use dot notation (e.g., detection.flooding.threshold)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="configValue" class="form-label">Configuration Value</label>
                        <input type="text" class="form-control" id="configValue" name="configValue" required>
                        <div class="form-text">The configuration value</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="configDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="configDescription" name="configDescription" rows="3"></textarea>
                        <div class="form-text">Describe what this configuration does</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isEncrypted" name="isEncrypted">
                            <label class="form-check-label" for="isEncrypted">
                                Encrypt this configuration value
                            </label>
                            <div class="form-text">Use for sensitive values like API keys or passwords</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function addConfig() {
        document.getElementById('configModalTitle').textContent = 'Add Configuration';
        document.getElementById('configForm').reset();
        document.getElementById('configId').value = '';
        
        const modal = new bootstrap.Modal(document.getElementById('configModal'));
        modal.show();
    }
    
    function editConfig(configId) {
        document.getElementById('configModalTitle').textContent = 'Edit Configuration';
        // In a real implementation, this would load config data via AJAX
        console.log('Loading config for editing:', configId);
        
        // Mock data for demonstration
        document.getElementById('configId').value = configId;
        document.getElementById('configKey').value = 'detection.flooding.packet_threshold';
        document.getElementById('configValue').value = '1000';
        document.getElementById('configDescription').value = 'Maximum packets per second before flooding alert';
        document.getElementById('isEncrypted').checked = false;
        
        const modal = new bootstrap.Modal(document.getElementById('configModal'));
        modal.show();
    }
    
    function saveConfig() {
        const form = document.getElementById('configForm');
        if (form.checkValidity()) {
            // In a real implementation, this would save via AJAX
            const configId = document.getElementById('configId').value;
            const configKey = document.getElementById('configKey').value;
            const configValue = document.getElementById('configValue').value;
            
            console.log('Saving configuration:', { configId, configKey, configValue });
            
            // Close modal and show success message
            const modal = bootstrap.Modal.getInstance(document.getElementById('configModal'));
            modal.hide();
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                Configuration saved successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').prepend(alertDiv);
            
            // Reload page after a short delay
            setTimeout(() => location.reload(), 1500);
        } else {
            form.reportValidity();
        }
    }
    
    function deleteConfig(configId) {
        if (confirm('Are you sure you want to delete this configuration setting? This action cannot be undone.')) {
            // In a real implementation, this would delete via AJAX
            console.log('Deleting configuration:', configId);
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                Configuration deleted successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').prepend(alertDiv);
            
            // Reload page after a short delay
            setTimeout(() => location.reload(), 1500);
        }
    }
</script>
{% endblock %}
